name: Bun container CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  IMAGE_NAME: bun-cluster-on-github-ubuntu-latest
  REGISTRY: ghcr.io

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up QEMU (for multi-arch, optional)
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build container image
        run: |
          docker build -t $IMAGE_NAME:ci .

      - name: Run container
        run: |
          docker run -d --name bun-ci -p 8080:8080 $IMAGE_NAME:ci
          # Wait for server to be ready
          for i in {1..30}; do
            if curl -fsS http://127.0.0.1:8080/ > /dev/null; then
              echo "Server is up"
              exit 0
            fi
            echo "Waiting for server..."
            sleep 1
          done
          echo "Server did not start in time"
          docker logs bun-ci || true
          exit 1

      - name: Test HTTP response
        run: |
          curl -v http://127.0.0.1:8080/

      - name: Stop container
        if: always()
        run: |
          docker stop bun-ci || true
          docker rm bun-ci || true

      # OPTIONAL: Push image to GitHub Container Registry (GHCR)
      # - name: Log in to GitHub Container Registry
      #   uses: docker/login-action@v3
      #   with:
      #     registry: ${{ env.REGISTRY }}
      #     username: ${{ github.actor }}
      #     password: ${{ secrets.GITHUB_TOKEN }}
      #
      # - name: Tag and push image
      #   run: |
      #     IMAGE_ID=${{ env.REGISTRY }}/${{ github.repository_owner }}/$IMAGE_NAME
      #     GIT_SHA=${{ github.sha }}
      #     docker tag $IMAGE_NAME:ci $IMAGE_ID:latest
      #     docker tag $IMAGE_NAME:ci $IMAGE_ID:$GIT_SHA
      #     docker push $IMAGE_ID:latest
      #     docker push $IMAGE_ID:$GIT_SHA
